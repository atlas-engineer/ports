# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           cmake 1.0
PortGroup           cxx11 1.0

name                widelands
categories          games
platforms           darwin
maintainers         gmail.com:ken.cunningham.webuse openmaintainer
license             GPL-2+
homepage            https://wl.widelands.org/


description         open-source real-time strategy game inspired by Settlers

depends_lib         port:libsdl2 \
                    port:libsdl2_image \
                    port:libsdl2_mixer \
                    port:libsdl2_net \
                    port:libsdl2_ttf \
                    port:boost \
                    port:doxygen \
                    port:libpng \
                    port:glew \
                    port:lua

subport ${name}-devel {}

if {${subport} eq ${name}} {

    # release
    version             build19
    master_sites        https://launchpad.net/${name}/${version}/${version}/+download/
    use_bzip2           yes
    distfiles           ${distname}-src${extract.suffix}
    worksrcdir          ${distname}-src/
    checksums           rmd160  5fd3e33dd0e9014811936a125d8f1b64607b2914 \
                        sha256  e511f9d26828a2b71b64cdfc6674e6e847543b2da73961ab882acca36c7c01a6

    conflicts       ${name}-devel
    long_description ${description}: \
        This port follows the release version of ${name}, which is typically updated every 6 months. If for some reason this port does not build or function as desired, try the ${name}-devel port.

} else {

    # devel

    fetch.type          bzr
    bzr.url             lp:widelands

    version             20170607
    # comment out for HEAD
    bzr.revision        8377
    
    # no longer uses this aspect of libsdl2 as of 8337 (uses boost networking instead)
    depends_lib-delete  port:libsdl2_net

    conflicts       ${name}
    long_description ${description}: \
        This port follows the master version of ${name}, which is typically updated every few days to weeks.

}

cmake.out_of_source yes
configure.args      -DCMAKE_INSTALL_PREFIX:PATH="${applications_dir}/Widelands.app/Contents/MacOS"


variant useglbinding description "use glbinding instead of glew for OpenGL bindings" {
    # for gl debugging. requires a new port, glbinding to be created first
    depends_lib-delete        port:glew
    depends_lib-append        path:lib/ibglbinding.dylib:glbinding
    configure.args-append     -DOPTION_USE_GLBINDING:BOOL=ON
}

pre-destroot {
    xinstall -d ${destroot}${applications_dir}/Widelands.app/Contents/Resources \
                ${destroot}${applications_dir}/Widelands.app/MacOS
    file copy ${worksrcpath}/data/images/logos/widelands.icns ${destroot}${applications_dir}/Widelands.app/Contents/Resources/widelands.icns
    set data    " {\n\
                CFBundleName = widelands;\n\
                CFBundleDisplayName = Widelands;\n\
                CFBundleIdentifier = \"org.widelands.wl\";\n\
                CFBundleVersion = ${version};\n\
                \"CFBundleInfoDictionaryVersion\" = \"6.0\";\n\
                CFBundlePackageType = APPL;\n\
                CFBundleSignature = \"????\";\n\
                CFBundleExecutable = widelands;\n\
                CFBundleIconFile = \"widelands.icns\";\n\
                }"
    set filename "${destroot}${applications_dir}/Widelands.app/Contents/Info.plist"
    set fileId [open $filename "w"]
    puts -nonewline $fileId $data
    close $fileId
}
