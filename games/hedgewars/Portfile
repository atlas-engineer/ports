# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

# -TO DO - port:hs-bytestring-show doesn't yet exist on macports so if we want to enable this

# Status - works correctly on 10.6 (w libc++), 10.7 (w libc++), and 10.12
# can build but fails in openGL code on 10.5 PPC

# this port uses a combination of c++, haskell, and also pascal code, 
# pascal code can be compiled either directly (with fpc)
# or via pas2c, which converts pascal to C code (this requires haskell compiler ghc)

PortSystem              1.0
PortGroup               cmake 1.0

name                    hedgewars
version                 0.9.22
categories              games
platforms               darwin
license                 GPL-2
maintainers             nomaintainer

description             Funny turn-based artillery game, featuring fighting Hedgehogs!
long_description        ${description}
homepage                https://www.hedgewars.org/

master_sites            http://download.gna.org/${name}/
use_bzip2               yes
distfiles               ${name}-src-${version}
worksrcdir              ${name}-src-${version}

checksums               md5     3718947ea69f57a76a3511678fb8173b \
                        sha1    53c2530df88c11297f3c1f6fc85a45f317644fe2 \
                        rmd160  359fd026643e69446121b94ba301646812353c19

cmake.out_of_source     yes

depends_build-append    port:pkgconfig \
                        port:ghc \
                        port:hs-vector \
                        port:hs-bytestring-show \
                        port:hs-network \
                        port:hs-dataenc \
                        port:hs-hslogger \
                        port:hs-utf8-string \
                        port:hs-sha \
                        port:hs-entropy \
                        port:hs-zlib \
                        port:hs-random
                    
depends_lib-append      port:ffmpeg \
					    port:libogg \
                        port:libsdl \
                        port:libsdl_image \
                        port:libsdl_ttf \
                        port:libsdl_mixer \
                        port:libsdl_net \
                        port:zlib \
                        port:libpng \
                        port:qt4-mac

# don't use the sparkle selfupdate mechanism; use macports update process instead
configure.args-append   -DNOAUTOUPDATE=1

# don't add all of the macports support libraries into the app bundle
configure.args-append   -DSKIPBUNDLE:BOOL=ON

# on some systems cmake needs help finding qt4's qmake
configure.args-append   -DQT_QMAKE_EXECUTABLE:FILEPATH=${prefix}/libexec/qt4/bin/qmake

# TO DO - decide whether to use the port's or the systems version of physfs
# for PPC, system version works better due to rpath code in PPC
# but the physfs doesn't build correctly on newer macs
# configure.args-append  -DPHYSFS_SYSTEM:BOOL=ON

# patch two source files to update to the current ffmpeg variable and procedure names
patchfiles-append       patch-0001-avwrapper-avframealloc-fix.diff
patchfiles-append       patch-0002-LibavInteraction-fix.diff

# change the link flags in the hwc engine build script
# to $(CXX_FLAGS), which provides the correct c++ stdlib and links properly
patchfiles-append       patch-0003-proj-hwc-CMakeLists-proper-link-flags.diff

# remove hard-coded link to stdlibc++ in QTfrontend build, and add in link to correct stdlib
# requires this to be -lc++ or -lstdc++ -- setting -stdlib=libc++ does not work
patchfiles-append       patch-0004-remove-hardcoded-stdlib-and-iokit-QTfrontend.diff
if { ${cxx_stdlib} eq "libc++"} {
    configure.ldflags-append -lc++
    } else {
    configure.ldflags-append -lstdc++
 }

# lan server fails to build with this optimization flag enabled
patchfiles-append       patch-0005-remove-haskell-spec-constr.diff

# by default, use the pas2c converter to build the application
configure.args-append -DBUILD_ENGINE_C:BOOL=ON

# if {${os.major} < 14} {
#   default_variants +usepascalcompiler
# }

# and then alter if we want to use the fpc pascal compiler instead
variant usepascalcompiler description "Build with the fpc pascal compiler" {
	depends_build-append   port:fpc

	# we need to fully specify the location of the pascal compiler to the cmake build system
	configure.args-append -DCMAKE_Pascal_COMPILER=${prefix}/lib/fpc/bin/fpc
	
	# and tell the CMake script to use the pascal compiler
	configure.args-replace -DBUILD_ENGINE_C:BOOL=ON -DBUILD_ENGINE_C:BOOL=OFF
}

# this app builds directly into build directory
#  move it to the proper location post-build, and install the man page
post-destroot {
    move ${destroot}${workpath}/build/Hedgewars.app ${destroot}${applications_dir}/Hedgewars.app
    move ${worksrcpath}/man/hedgewars.6 ${destroot}${prefix}/share/man/man6/hedgewars.6
 }
