# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           cmake 1.0

name                hedgewars
version             0.9.22
categories          games
platforms           darwin
license             GPL-2
maintainers         nomaintainer

description         Funny turn-based artillery game, featuring fighting Hedgehogs!
long_description    ${description}
homepage            https://www.hedgewars.org/

master_sites        http://download.gna.org/${name}/
use_bzip2           yes
distfiles           ${name}-src-${version}
worksrcdir          ${name}-src-${version}

checksums           md5     3718947ea69f57a76a3511678fb8173b \
                    sha1    53c2530df88c11297f3c1f6fc85a45f317644fe2 \
                    rmd160  359fd026643e69446121b94ba301646812353c19

cmake.out_of_source yes


depends_build-append    port:fpc \
                        port:pkgconfig
                       
depends_lib-append  port:ffmpeg \
					port:libogg \
                    port:libsdl \
                    port:libsdl_image \
                    port:libsdl_ttf \
                    port:libsdl_mixer \
                    port:libsdl_net \
                    port:zlib \
                    port:libpng \
                    port:qt4-mac \
                    port:physfs


# don't build the server unit by default as it has high overhead (ghc, llvm-3.5)
# and at the moment, will not build anyway using macports haskell port
configure.args-append -DNOSERVER=1

# don't use the sparkle selfupdate mechanism
configure.args-append -DNOAUTOUPDATE=1

# don't include all of the macports support libraries in the app bundle
configure.args-append -DSKIPBUNDLE:BOOL=ON

configure.args-append -DBUILD_ENGINE_C:BOOL=ON

# newer systems need help finding qt4's qmake
configure.args-append -DQT_QMAKE_EXECUTABLE:FILEPATH=${prefix}/libexec/qt4/bin/qmake

# the physfs doesn't build correctly on newer macs
# configure.args-append -DPHYSFS_SYSTEM:BOOL=ON

# patch sources to update to the current ffmpeg variable and procedure names
patchfiles-append   0001-avwrapper-avframealloc-fix.diff
patchfiles-append   0002-LibavInteraction-fix.diff


####### C++ LINK ISSUE SECTION #########
# linking to the standard c++ lib is non-standard in this port
# as it comes, the port uses a hard-coded link to stdc++
# this has to be modified in two areas

# first, change the link flags in the hwc engine build script
patchfiles-append   0003-patch-proj-hwc-CMakeLists-proper-link-flags.diff


## TO DO -- change link library depending on standard c++ library
# second, adjust the link in the QTfrontend CMake build script
# oddly, the usual -stdlib=libc++ fails to link correctly
# this build requires explicitly specifying c++ or stdc++

# we could edit CMakeLists.txt file to add in a placeholder
# and reinplace it on-the-fly
# patchfiles-append   0004-patch-QT-CMakeLists-stdlib-fix.diff
#pre-configure {
#    reinplace "s|@@STDLIB@@|c++|g" ${worksrcpath}/QTfrontend/CMakeLists.txt
#}

# or we can approach it like this, removing the hard-coded std lib, 
# and adding in the proper one on the ldflags line
patchfiles-append   0003-patch-remove-hardcoded-stdlib-and-iokit-QTfrontend.patch

# this doesn't work, even though it shows up on the link line - which is confusing
#configure.ldflags-append -stdlib=libc++
# but this does
configure.ldflags-append -lc++

####### END C++ LINK ISSUE SECTION #########



####### PASCAL COMPILER SECTION #########
variant usepascalcompiler description "Build with the fpc pascal compiler" {
    # fpc seems to have trouble on newer macOS systems
	# perhaps fpc doesn't like deployment targets to have two final digits
	# tried the adjust this with changing deployment targets, but this didn't work
	#build.env-append MACOSX_DEPLOYMENT_TARGET="10.9"
	#configure.env-append MACOSX_DEPLOYMENT_TARGET="10.9"
	#macosx_deployment_target 10.11
	
	# only needed if we're building with the pascal compiler instead of pas2c
	depends_build-append    port:fpc
	# fully specify the location of the pascal compiler to the cmake build system
	configure.args-append -DCMAKE_Pascal_COMPILER=${prefix}/lib/fpc/bin/fpc
	configure.args-replace -DBUILD_ENGINE_C:BOOL=ON -DBUILD_ENGINE_C:BOOL=OFF
}
                        
####### LAN SERVER SECTION #########
# ghc and llvm-3.5 are expensive to build so first of all make them optional
# however, the server doesn't build at present (20170111) on macports
# due to haskell unrecognized symbols when compiling the haskell source
# -TO DO - see if haskell can be updated to fix server
# -TO DO - port:hs-bytestring-show doesn't yet exist on macports
# variant server description "Add LAN server" {
#     configure.args-replace -DNOSERVER=1 -DNOSERVER=0
#     depends_build-append    port:ghc \
#                             port:hs-vector \
#                             port:hs-bytestring-show \
#                             port:hs-network \
#                             port:hs-dataenc \
#                             port:hs-hslogger \
#                             port:hs-utf8-string \
#                             port:hs-sha \
#                             port:hs-entropy \
#                             port:hs-zlib \
#                             port:hs-random
# }


# this app builds itself directly into build directory
# so move it to the proper location post-build
post-destroot {
    move ${destroot}${workpath}/build/Hedgewars.app ${destroot}${applications_dir}/Hedgewars.app
 }
