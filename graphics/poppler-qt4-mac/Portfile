# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:filetype=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           compiler_blacklist_versions 1.0
PortGroup           cxx11 1.1
#PortGroup           gobject_introspection 1.0
PortGroup           cmake 1.1
PortGroup           qt4 1.0

name                poppler-qt4-mac
conflicts           xpdf-tools
version             0.61.1
license             GPL-2+
maintainers         {devans @dbevans} openmaintainer
categories          graphics
platforms           darwin
homepage            https://poppler.freedesktop.org/

description         Poppler is a PDF rendering library based on the xpdf-3.0 code base.
long_description    ${description}

master_sites        ${homepage}
distname            poppler-${version}

use_xz              yes

checksums           rmd160  62fa0f917e31e0c733228ea9289b4493a0fc29a8 \
                    sha256  1266096343f5163c1a585124e9a6d44474e1345de5cdfe55dc7b47357bcfcda9 \
                    size    1433696

depends_build       port:pkgconfig

depends_lib         port:bzip2 \
                    port:curl \
                    port:expat \
                    port:fontconfig \
                    port:freetype \
                    port:jpeg \
                    path:lib/pkgconfig/glib-2.0.pc:glib2 \
                    path:lib/pkgconfig/cairo.pc:cairo \
                    port:lcms2 \
                    port:libpng \
                    port:openjpeg \
                    port:poppler-data \
                    port:tiff \
                    port:zlib

configure.ldflags-append -liconv
configure.cxxflags-append -std=c++11
#gobject_introspection yes
configure.env-append    MOCQT4=${qt_bins_dir}/moc

cmake.install_prefix ${prefix}/libexec/${name}
cmake.install_rpath  ${destroot}${prefix}/libexec/${name}/lib
cmake_share_module_dir ${prefix}/libexec/${name}/share/cmake/Modules

configure.args-append \
                    -DENABLE_XPDF_HEADERS=ON \
                    -DENABLE_QT4=ON \
                    -DENABLE_QT5=OFF \
                    -DBUILD_GTK_TESTS=OFF \
                    -DBUILD_QT5_TESTS=OFF \
                    -DBUILD_CPP_TESTS=OFF \
                    -DWITH_NSS3=OFF \
                    -DENABLE_GLIB=OFF

# patchfiles          patch-CVE-2017-18267.diff


#if {${subport} ne ${name}} {
#    depends_extract-append  port:git
#
#    depends_lib-append      port:poppler61
#
#    post-extract {
#        system -W ${workpath} "${prefix}/bin/git clone --depth=1 http://anongit.freedesktop.org/git/poppler/test"
#    }

# currently poppler only provides unit tests for the Qt wrappers

#    test.run    yes
#    test.target check

#    post-destroot {
#        foreach dot_h [glob -nocomplain -directory ${destroot}${prefix}/include/poppler *.h] {
#            delete $dot_h
#        }
#        foreach libpoppler [glob -nocomplain ${destroot}${prefix}/lib/libpoppler.*] {
#            delete ${libpoppler}
#        }
#        delete  ${destroot}${prefix}/include/poppler/fofi \
#                ${destroot}${prefix}/include/poppler/goo \
#                ${destroot}${prefix}/include/poppler/splash \
#                ${destroot}${prefix}/lib/pkgconfig/poppler-splash.pc \
#                ${destroot}${prefix}/lib/pkgconfig/poppler.pc
#    }
#}
