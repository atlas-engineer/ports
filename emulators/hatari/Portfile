# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem              1.0
PortGroup               cmake 1.0
PortGroup               compiler_blacklist_versions 1.0
name                    hatari
version                 2.0.0
categories              emulators
license                 GPL-2+
platforms               darwin

maintainers             slor.net:james gmail.com:ken.cunningham.webuse openmaintainer
description             Atari ST/STe/STfm emulator
long_description        Hatari is an actively developed Atari ST/STe/STfm and Falcon emulator
homepage                http://hatari.tuxfamily.org/
master_sites            http://download.tuxfamily.org/hatari/${version}/
checksums               sha256  52a447a59b6979d55d1525f3c4a21ec013e4371354d6683ede71546c5e6da577 \
                        rmd160  5277b0b9ffc65b7e604669498408f68e5da5ce77
use_bzip2               yes
cmake.out_of_source     yes

depends_lib             port:libsdl \
                        port:libpng \
                        port:readline \
                        port:portaudio

# 1. fix hard-coded installation directory for macOS bundle
# 2. delete warning flag in winuae emulator code not supported by GCC42
# 3. disable python ui - not needed for macOS
post-patch {
    reinplace "s|/Applications|${applications_dir}|g" ${worksrcpath}/src/CMakeLists.txt
    reinplace "s|-Wno-maybe-uninitialized||g" ${worksrcpath}/src/cpu/CMakeLists.txt
    reinplace "s|add_subdirectory(python-ui)||g" ${worksrcpath}/CMakeLists.txt
}

# ensure cmake's choice of compiler is correctly passed in (doesn't always seem to be)
configure.args-append   -DCMAKE_C_COMPILER=${configure.cc}

# these settings are copied from the previous portfile (1.7 version)
configure.cflags        -O3 -pipe -fomit-frame-pointer
configure.universal_args-delete --disable-dependency-tracking


# the CAPSImage library can be included, but at present there are manual steps that will need to be done for this to work
# 1. download the dmg from here <http://www.softpres.org/_media/files:ipflib42_macosx-universal.dmg.zip?id=download&cache=cache>
# 2. move the framework and include files into the proper locations indicated below
# 3. change ownership and permissions on the include files and library appropriately
#     a) sudo chown -R root:admin ${prefix}/Library/Frameworks/CAPSImage.framework
#     b) sudo chmod -R 644 ${prefix}/include/cap
# 4. update the install name of the library, like below
#     a) "sudo install_name_tool -id ${prefix}/Library/Frameworks/CAPSImage.framework/Versions/A/CAPSImage \
            ${prefix}/Library/Frameworks/CAPSImage.framework/Versions/A/CAPSImage"

set capsimage_framework ${prefix}/Library/Frameworks/capsimage.framework
if {[file exists $capsimage_framework]} {
    configure.args-append   -DCAPSIMAGE_INCLUDE_DIR:PATH=${prefix}/include/cap
    configure.args-append   -DCAPSIMAGE_LIBRARY:FILEPATH=${prefix}/Library/Frameworks/capsimage.framework
}


platform darwin {
    # for portfile logic, default to command line (SDL GUI) app and sdl version 1
    configure.args-append    -DENABLE_OSX_BUNDLE:BOOL=0
    configure.args-append    -DENABLE_SDL2:BOOL=0

    # 10.6 or greater should build with libsdl2
    if { ${os.major} > 9 } {
        default_variants    +sdl2
    }

    # 10.9 or greater should build macOS GUI
    if { ${os.major} > 12 } {
        default_variants    +macOSGUI
    }
}

variant macOSGUI description "Build macOS GUI Application (10.9+)" {
    compiler.blacklist     *gcc* { clang < 211 }
    configure.args-append   -DENABLE_OSX_BUNDLE:BOOL=1
    post-destroot {
        copy ${worksrcpath}/src/tos.img ${destroot}${applications_dir}/hatari.app/Contents/Resources/tos.img
    }
}

variant sdl2 description "Use SDL 2.0 instead of SDL 1.2 (10.6+)" {
    configure.args-append  -DENABLE_SDL2:BOOL=1
    depends_lib-replace     port:libsdl port:libsdl2
}

notes "
A free Atari-compatible ROM, EmuTOS, is installed with this port.

    http://sourceforge.net/projects/emutos

An online manual has been installed at

    file://${prefix}/share/doc/hatari/manual.html

and can be accessed via the Help menu in the macOS GUI application.
"
